package rs.kunpero.slackbot.dutycarousel.scheduler;

import com.slack.api.methods.MethodsClient;
import com.slack.api.methods.SlackApiException;
import com.slack.api.methods.response.chat.ChatPostMessageResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;
import rs.kunpero.slackbot.dutycarousel.entity.DutyList;
import rs.kunpero.slackbot.dutycarousel.entity.DutyUser;
import rs.kunpero.slackbot.dutycarousel.repository.DutyListRepository;
import rs.kunpero.slackbot.vacation.entity.VacationInfo;
import rs.kunpero.slackbot.vacation.repository.VacationInfoRepository;

import java.io.IOException;
import java.time.Clock;
import java.time.LocalDate;
import java.util.Iterator;
import java.util.List;

import static rs.kunpero.slackbot.vacation.util.ViewHelperUtils.buildDutyNotifyPostRequest;

@Component
@Slf4j
@RequiredArgsConstructor
public class DutyCarouselTask {
    public final static String IS_DAY_OFF_SERVICE_URL = "https://isdayoff.ru/%s";

    private final DutyListRepository dutyListRepository;
    private final VacationInfoRepository vacationInfoRepository;
    private final Clock clock;
    private final OkHttpClient okHttpClient;
    private final MethodsClient methodsClient;

    @Scheduled(cron = "${next.duty.cron}")
    public void nextDuty() throws IOException, SlackApiException {
        log.info("nextDuty task started");

        LocalDate currentDay = LocalDate.now();
        String stringValue = currentDay.toString().replaceAll("-", "");
        Request request = new Request.Builder()
                .url(String.format(IS_DAY_OFF_SERVICE_URL, stringValue))
                .build();
        Response response = okHttpClient.newCall(request).execute();
        String code = response.body().string();
        if ("1".equals(code)) {
            log.info("It's a holiday today! Terminate task...");
            return;
        }
        List<DutyList> lists = dutyListRepository.findAll();
        if (CollectionUtils.isEmpty(lists)) {
            log.info("No active duty lists");
            return;
        }

        for (DutyList list : lists) {
            processDutyList(list);
        }
    }

    void processDutyList(DutyList list) throws IOException, SlackApiException {
        DutyUser newDutyUser = findNewDutyUser(list);
        dutyListRepository.save(list);
        notifyChannel(newDutyUser.getUserId(), list.getChannelId());
    }

    private DutyUser findNewDutyUser(DutyList list) {
        int maxIterationsValue = list.getUsers().size();
        List<VacationInfo> currentVacations = vacationInfoRepository.findByTeamIdAndDateBetween(list.getTeamId(), LocalDate.now(clock));
        for (Iterator<DutyUser> userIterator = circularIterator(list.getUsers(), list.getUsers().size()); userIterator.hasNext(); ) {
            DutyUser currentDutyUser = userIterator.next();
            if (!currentDutyUser.isOnDuty()) {
                continue;
            }

            int i = 0;
            while (i < maxIterationsValue - 1) {
                i++;
                DutyUser newDutyUser = userIterator.next();
                boolean isOnVacation = currentVacations.stream()
                        .anyMatch(info -> info.getUserId().equals(newDutyUser.getUserId()));
                if (!isOnVacation) {
                    currentDutyUser.setOnDuty(false);
                    newDutyUser.setOnDuty(true);
                    newDutyUser.setLastDateOnDuty(LocalDate.now(clock));
                    return newDutyUser;
                }
            }
            log.warn("New user on duty was not chosen!");
            return currentDutyUser;
        }
        throw new RuntimeException("Unexpected error");
    }

    private void notifyChannel(String userId, String channelId) throws IOException, SlackApiException {
        ChatPostMessageResponse response = methodsClient
                .chatPostMessage(buildDutyNotifyPostRequest(channelId, userId));
        log.debug(response.toString());
    }

    private static <T> Iterator<T> circularIterator(List<T> list, int count) {
        int size = list.size();
        return new Iterator<>() {
            int i = 0;

            @Override
            public boolean hasNext() {
                return i < count;
            }

            @Override
            public T next() {
                return list.get(i++ % size);
            }
        };
    }


    public static void main(String[] args) {
        String str = "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\"\u2028    \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\u2028<html xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"en\" xml:lang=\"en\"\u2028      style=\"background:#fff!important;box-sizing:border-box\">\u2028<head style=\"box-sizing:border-box\">\u2028    <link rel=\"stylesheet\" type=\"text/css\" href=\"../css/app.css\" style=\"box-sizing:border-box\">\u2028    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" style=\"box-sizing:border-box\">\u2028    <meta name=\"viewport\" content=\"width=device-width\" style=\"box-sizing:border-box\">\u2028    <title style=\"box-sizing:border-box\"></title>\u2028    <style>@media only screen {\u2028        html {\u2028            min-height: 100%;\u2028            background: #f8f8f8\u2028        }\u2028    }\u2028\u2028    @media only screen and (max-width: 624px) {\u2028        table.body img {\u2028            width: auto;\u2028            height: auto\u2028        }\u2028\u2028        table.body center {\u2028            min-width: 0 !important\u2028        }\u2028\u2028        table.body .container {\u2028            width: 100% !important\u2028        }\u2028\u2028        table.body .columns {\u2028            height: auto !important;\u2028            -moz-box-sizing: border-box;\u2028            -webkit-box-sizing: border-box;\u2028            box-sizing: border-box;\u2028            padding-left: 24px !important;\u2028            padding-right: 24px !important\u2028        }\u2028\u2028        th.small-12 {\u2028            display: inline-block !important;\u2028            width: 100% !important\u2028        }\u2028\u2028        table.menu {\u2028            width: 100% !important\u2028        }\u2028\u2028        table.menu td, table.menu th {\u2028            width: auto !important;\u2028            display: inline-block !important\u2028        }\u2028\u2028        table.menu.vertical td, table.menu.vertical th {\u2028            display: block !important\u2028        }\u2028\u2028        table.menu[align=center] {\u2028            width: auto !important\u2028        }\u2028\u2028        table.button.small-expanded {\u2028            width: 100% !important\u2028        }\u2028\u2028        table.button.small-expanded table {\u2028            width: 100%\u2028        }\u2028\u2028        table.button.small-expanded table a {\u2028            text-align: center !important;\u2028            width: 100% !important;\u2028            padding-left: 0 !important;\u2028            padding-right: 0 !important\u2028        }\u2028    }</style>\u2028</head>\u2028<body\u2028    style=\"-moz-box-sizing:border-box;-ms-text-size-adjust:100%;-webkit-box-sizing:border-box;-webkit-text-size-adjust:100%;Margin:0;background:#fff!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:1.5;margin:0;min-width:100%;padding:0;text-align:left;width:100%!important\">\u2028<span class=\"preheader\"\u2028      style=\"box-sizing:border-box;color:#f8f8f8;display:none!important;font-size:1px;line-height:1px;max-height:0;max-width:0;mso-hide:all!important;opacity:0;overflow:hidden;visibility:hidden\"></span>\u2028<table class=\"body\"\u2028       style=\"Margin:0;background:#fff!important;border-collapse:collapse;border-spacing:0;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;height:100%;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028    <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028        <td class=\"center\" align=\"center\" valign=\"top\"\u2028            style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028            <center data-parsed style=\"box-sizing:border-box;min-width:600px;width:100%\">\u2028                <table align=\"center\" class=\"container float-center\"\u2028                       style=\"Margin:0 auto;background:#fefefe;border-collapse:collapse;border-spacing:0;box-sizing:border-box;float:none;margin:0 auto;padding:0;text-align:center;vertical-align:top;width:600px\">\u2028                    <tbody style=\"box-sizing:border-box\">\u2028                    <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                        <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                            <table class=\"spacer\"\u2028                                   style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                <tbody style=\"box-sizing:border-box\">\u2028                                <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                    <td height=\"32px\"\u2028                                        style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:32px;font-weight:400;hyphens:auto;line-height:32px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                        &#xA0;\u2028                                    </td>\u2028                                </tr>\u2028                                </tbody>\u2028                            </table>\u2028                            <table class=\"row\"\u2028                                   style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;display:table;padding:0;position:relative;text-align:left;vertical-align:top;width:100%\">\u2028                                <tbody style=\"box-sizing:border-box\">\u2028                                <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                    <th class=\"small-12 large-12 columns first last\"\u2028                                        style=\"Margin:0 auto;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:1.5;margin:0 auto;padding:0;padding-bottom:0;padding-left:24px;padding-right:24px;text-align:left;width:576px\">\u2028                                        <table\u2028                                            style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                            <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                <th style=\"Margin:0;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:1.5;margin:0;padding:0;text-align:left\">\u2028                                                    <img width=\"156\" height=\"44\"\u2028                                                         src=\"https://securepayments.sberbank.ru/img/output-onlinepngtools_1.png\"\u2028                                                         alt=\"logo\"\u2028                                                         style=\"-ms-interpolation-mode:bicubic;box-sizing:border-box;clear:both;display:block;height:44px;max-width:100%;outline:0;text-decoration:none;width:156px\">\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"32px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:32px;font-weight:400;hyphens:auto;line-height:32px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <h2 style=\"Margin:0;Margin-bottom:0;box-sizing:border-box;color:inherit;font-family:Helvetica,Arial,sans-serif;font-size:22px;font-weight:700;letter-spacing:1px;line-height:1.5;margin:0;margin-bottom:0;padding:0;text-align:left;word-wrap:normal\">\u2028                                                        Здравствуйте, ${(name)!}.</h2>\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"7px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:7px;font-weight:400;hyphens:auto;line-height:7px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <p style=\"Margin:0;Margin-bottom:0;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:16px;font-weight:400;letter-spacing:.5px;line-height:1.5;margin:0;margin-bottom:0;padding:0;text-align:left\">\u2028                                                        Мы благодарим Вас за заказ <strong\u2028                                                        style=\"box-sizing:border-box\">№${(orderNumber)!}</strong> на сайте\u2028                                                        <span class=\"site-name\"\u2028                                                              style=\"box-sizing:border-box;color:#01be61\">${(merchantName)!}</span>.\u2028                                                        Срок действия заказа <strong style=\"box-sizing:border-box\">до\u2028                                                        ${(expiredDate)!}</strong>.</p>\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"30px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:30px;font-weight:400;hyphens:auto;line-height:30px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <h3 style=\"Margin:0;Margin-bottom:0;box-sizing:border-box;color:inherit;font-family:Helvetica,Arial,sans-serif;font-size:16px;font-weight:700;letter-spacing:1.5px;line-height:1.5;margin:0;margin-bottom:0;padding:0;text-align:left;word-wrap:normal\">\u2028                                                        ОПИСАНИЕ ЗАКАЗА</h3>\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"4px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:4px;font-weight:400;hyphens:auto;line-height:4px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <p style=\"Margin:0;Margin-bottom:0;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:1.5;margin:0;margin-bottom:0;padding:0;text-align:left\">\u2028                                                        ${(orderDescription)!}</p><!--      <table class=\"stuff-table\">-->\u2028                                                    <!--        <tr>--><!--          <td>{stuff_name}</td>-->\u2028                                                    <!--          <td>{stuff_value}</td>--><!--        </tr>-->\u2028                                                    <!--      </table>-->\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"24px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:24px;font-weight:400;hyphens:auto;line-height:24px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <hr style=\"border-color:#dbdbdb;border-style:solid;border-width:1px 0 0 0;box-sizing:border-box\">\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"24px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:24px;font-weight:400;hyphens:auto;line-height:24px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <h3 style=\"Margin:0;Margin-bottom:0;box-sizing:border-box;color:inherit;font-family:Helvetica,Arial,sans-serif;font-size:16px;font-weight:700;letter-spacing:1.5px;line-height:1.5;margin:0;margin-bottom:0;padding:0;text-align:left;word-wrap:normal\">\u2028                                                        СУММА ЗАКАЗА: ${(amountFormatted)!} ${(currencyName)!}</h3>\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"6px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:6px;font-weight:400;hyphens:auto;line-height:6px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <p style=\"Margin:0;Margin-bottom:0;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:1.5;margin:0;margin-bottom:0;padding:0;text-align:left\">\u2028                                                        <small\u2028                                                            style=\"box-sizing:border-box;color:#7d7d7d;font-size:14px\">Получите\u2028                                                            онлайн необходимую для оплаты сумму, оформив заявку на\u2028                                                            кредит.</small></p>\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"32px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:32px;font-weight:400;hyphens:auto;line-height:32px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <table class=\"button large small-expanded radius primary-color\"\u2028                                                           style=\"Margin:0;border-collapse:collapse;border-spacing:0;box-sizing:border-box;margin:0;padding:0;text-align:left;vertical-align:top;width:auto\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                <table\u2028                                                                    style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                                    <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                                        <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;background:#01be61;border:none;border-collapse:collapse!important;border-radius:4px;box-sizing:border-box;color:#fefefe;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                            <a href=\"${formUrl}\"\u2028                                                                               style=\"Margin:0;background-color:#01be61;border:0 solid #01be61;border-radius:4px;box-sizing:border-box;color:#fefefe;display:inline-block;font-family:Helvetica,Arial,sans-serif;font-size:18px;font-weight:700;line-height:1.5;margin:0;padding:18px 43px 18px 43px;text-align:left;text-decoration:none\">Купить\u2028                                                                                в кредит</a></td>\u2028                                                                    </tr>\u2028                                                                </table>\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                    </table>\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"32px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:32px;font-weight:400;hyphens:auto;line-height:32px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                </th>\u2028                                                <th class=\"expander\"\u2028                                                    style=\"Margin:0;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:1.5;margin:0;padding:0!important;text-align:left;visibility:hidden;width:0\"></th>\u2028                                            </tr>\u2028                                        </table>\u2028                                    </th>\u2028                                </tr>\u2028                                </tbody>\u2028                            </table>\u2028                            <table\u2028                                style=\"background-color:#f8f8f8;border-collapse:collapse;border-spacing:0;box-sizing:border-box;display:table;padding:0;position:relative;text-align:left;vertical-align:top;width:100%\"\u2028                                class=\"row\">\u2028                                <tbody style=\"box-sizing:border-box\">\u2028                                <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                    <th class=\"small-12 large-12 columns first last\"\u2028                                        style=\"Margin:0 auto;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:1.5;margin:0 auto;padding:0;padding-bottom:0;padding-left:24px;padding-right:24px;text-align:left;width:576px\">\u2028                                        <table\u2028                                            style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                            <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                <th style=\"Margin:0;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:1.5;margin:0;padding:0;text-align:left\">\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"32px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:32px;font-weight:400;hyphens:auto;line-height:32px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <h2 style=\"Margin:0;Margin-bottom:0;box-sizing:border-box;color:inherit;font-family:Helvetica,Arial,sans-serif;font-size:22px;font-weight:700;letter-spacing:1px;line-height:1.5;margin:0;margin-bottom:0;padding:0;text-align:left;word-wrap:normal\">\u2028                                                        Совершать покупки в кредит легко</h2>\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"21px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:21px;font-weight:400;hyphens:auto;line-height:21px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                    <table class=\"additional-offers-table\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\">\u2028                                                                <img width=\"27\" height=\"32\"\u2028                                                                     src=\"https://securepayments.sberbank.ru/img/output-onlinepngtools_2.png\"\u2028                                                                     alt=\"icon\"\u2028                                                                     style=\"-ms-interpolation-mode:bicubic;box-sizing:border-box;clear:both;display:block;height:32px;max-width:100%;outline:0;text-decoration:none;width:27px\">\u2028                                                            </td>\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                1. Чтобы оплатить заказ с помощью «Покупай со Сбером» нажмите «Купить в кредит».\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;height:18px;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\"></td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;width:49px;word-wrap:break-word\">\u2028                                                                <img width=\"29\" height=\"27\"\u2028                                                                     src=\"https://securepayments.sberbank.ru/img/output-onlinepngtools_3.png\"\u2028                                                                     alt=\"icon\"\u2028                                                                     style=\"-ms-interpolation-mode:bicubic;box-sizing:border-box;clear:both;display:block;height:27px;max-width:100%;outline:0;text-decoration:none;width:29px\">\u2028                                                            </td>\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                2. Ознакомьтесь с минимальными требованиями к заемщику и\u2028                                                                нажмите «Подать заявку через СберБанк Онлайн».\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;height:18px;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\"></td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\">\u2028                                                                <img width=\"26\" height=\"28\"\u2028                                                                     src=\"https://securepayments.sberbank.ru/img/output-onlinepngtools_4.png\"\u2028                                                                     alt=\"icon\"\u2028                                                                     style=\"-ms-interpolation-mode:bicubic;box-sizing:border-box;clear:both;display:block;height:28px;max-width:100%;outline:0;text-decoration:none;width:26px\">\u2028                                                            </td>\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                3. Авторизуйтесь в СберБанк Онлайн, выберите срок\u2028                                                                кредитования и заполните заявку.\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;height:18px;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\"></td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\">\u2028                                                                <img width=\"28\" height=\"28\"\u2028                                                                     src=\"https://securepayments.sberbank.ru/img/output-onlinepngtools_5.png\"\u2028                                                                     alt=\"icon\"\u2028                                                                     style=\"-ms-interpolation-mode:bicubic;box-sizing:border-box;clear:both;display:block;height:28px;max-width:100%;outline:0;text-decoration:none;width:28px\">\u2028                                                            </td>\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                4. Дождитесь решения банка. Если кредит одобрен,\u2028                                                                подтвердите согласие с его условиями в СберБанк Онлайн.\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;height:28px;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\"></td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\">\u2028                                                                <img width=\"27\" height=\"23\"\u2028                                                                     src=\"https://securepayments.sberbank.ru/img/output-onlinepngtools_6.png\"\u2028                                                                     alt=\"icon\"\u2028                                                                     style=\"-ms-interpolation-mode:bicubic;box-sizing:border-box;clear:both;display:block;height:23px;max-width:100%;outline:0;text-decoration:none;width:27px\">\u2028                                                            </td>\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                5. После оплаты свяжитесь с <span class=\"site-name\"\u2028                                                                                                  style=\"box-sizing:border-box;color:#01be61\">${(merchantName)!}</span>.\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;height:140px;hyphens:auto;line-height:1.5;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\"></td>\u2028                                                        </tr>\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td colspan=\"2\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;hyphens:auto;line-height:1.43;margin:0;padding:0;text-align:left;vertical-align:middle;word-wrap:break-word\">\u2028                                                                Кредит предоставляется ПАО Сбербанк. Генеральная\u2028                                                                лицензия<br style=\"box-sizing:border-box\">на\u2028                                                                осуществление банковских операций от 11 августа 2015\u2028                                                                года.<br style=\"box-sizing:border-box\">Регистрационный\u2028                                                                номер — 1481.\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                    </table>\u2028                                                    <table class=\"spacer\"\u2028                                                           style=\"border-collapse:collapse;border-spacing:0;box-sizing:border-box;padding:0;text-align:left;vertical-align:top;width:100%\">\u2028                                                        <tbody style=\"box-sizing:border-box\">\u2028                                                        <tr style=\"box-sizing:border-box;padding:0;text-align:left;vertical-align:top\">\u2028                                                            <td height=\"32px\"\u2028                                                                style=\"-moz-hyphens:auto;-webkit-hyphens:auto;Margin:0;border-collapse:collapse!important;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:32px;font-weight:400;hyphens:auto;line-height:32px;margin:0;mso-line-height-rule:exactly;padding:0;text-align:left;vertical-align:top;word-wrap:break-word\">\u2028                                                                &#xA0;\u2028                                                            </td>\u2028                                                        </tr>\u2028                                                        </tbody>\u2028                                                    </table>\u2028                                                </th>\u2028                                                <th class=\"expander\"\u2028                                                    style=\"Margin:0;box-sizing:border-box;color:#333;font-family:Helvetica,Arial,sans-serif;font-size:14px;font-weight:400;line-height:1.5;margin:0;padding:0!important;text-align:left;visibility:hidden;width:0\"></th>\u2028                                            </tr>\u2028                                        </table>\u2028                                    </th>\u2028                                </tr>\u2028                                </tbody>\u2028                            </table>\u2028                        </td>\u2028                    </tr>\u2028                    </tbody>\u2028                </table>\u2028            </center>\u2028        </td>\u2028    </tr>\u2028</table><!-- prevent Gmail on iOS font size manipulation -->\u2028<div style=\"box-sizing:border-box;display:none;font:15px courier;line-height:0;white-space:nowrap\">&nbsp; &nbsp; &nbsp;\u2028    &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\u2028    &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\u2028</div>\u2028</body>\u2028</html>\u2028";
        int size = str.length();
        int chunks = size / 4000 + 1;

        String[] arr = new String[chunks];

        for (int i = 0; i < chunks; i++) {
            arr[i] = str.substring(i * chunks, chunks);
        }

        System.out.println(arr);
    }
}
